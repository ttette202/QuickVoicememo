<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>webãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ v16</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³ (v15ãƒ™ãƒ¼ã‚¹) --- */
        body { font-family: -apple-system, sans-serif; background: #f4f7f6; color: #333; margin: 0; padding-bottom: 120px; overscroll-behavior-y: none; }
        header { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 10; }
        h1 { margin: 0; font-size: 18px; color: #2c3e50; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; }
        
        #menuOverlay { display: none; position: absolute; top: 55px; right: 10px; background: #2c3e50; color: white; border-radius: 8px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 250px; flex-direction: column; gap: 10px; z-index: 100; }
        #menuOverlay.open { display: flex; }
        .menu-item { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px; border-radius: 5px; cursor: pointer; text-align: left; font-size: 14px; }

        .storage-info { font-size: 12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-bottom: 5px; }
        .storage-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .storage-bar-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.5s; }

        #libraryContainer { padding: 20px 15px; max-width: 800px; margin: 0 auto; }
        .folder-section { background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .folder-header { background: #ecf0f1; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #2c3e50; }
        .delete-folder-btn { border: none; background: none; color: #95a5a6; cursor: pointer; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .item-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #7f8c8d; }
        .delete-btn { color: #e74c3c; background: none; border: none; cursor: pointer; text-decoration: underline; }
        audio { width: 100%; height: 32px; }
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 20px; z-index: 50; }
        .fab-btn { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #addFolderFab { background: #3498db; font-size: 28px; } #addFolderFab::after { content: "ğŸ“+"; font-size: 16px; }
        #startFab { background: #e74c3c; font-size: 32px; } #startFab::before { content: "ğŸ™ï¸"; }
        
        .overlay-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center; color: white; backdrop-filter: blur(5px); }
        .overlay-screen.active { display: flex; }
        .folder-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; max-height: 70vh; overflow-y: auto; padding: 20px;}
        .folder-btn { background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 20px; border-radius: 12px; font-weight: bold; cursor: pointer; text-align: center; }
        .close-overlay-btn { margin-top: 30px; background: none; border: none; color: #ccc; text-decoration: underline; cursor: pointer; }
        .recording-status { font-size: 24px; margin-bottom: 20px; font-weight: bold; }
        .timer-display { font-size: 48px; font-family: monospace; margin-bottom: 50px; }
        .big-stop-btn { width: 100px; height: 100px; border-radius: 50%; background: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .big-stop-btn div { width: 30px; height: 30px; background: #e74c3c; border-radius: 4px; }
        .review-controls { display: flex; flex-direction: column; gap: 15px; width: 300px; }
        .action-btn { padding: 15px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; }
        .btn-resume { background: #3498db; color: white; }
        .btn-save { background: #2ecc71; color: white; margin-top: 10px; }
        .btn-discard { background: transparent; color: #e74c3c; border: 1px solid #e74c3c; margin-top: 10px; }
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; justify-content:center; align-items:center; color:#333; font-weight:bold; }
        #loader.active { display: flex; }

        /* ãƒ­ãƒƒã‚¯ç”»é¢ */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a252f; color: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #pinInput {
            font-size: 24px; padding: 10px; text-align: center; letter-spacing: 5px;
            border: none; border-bottom: 2px solid white; background: transparent; color: white;
            width: 150px; margin-bottom: 20px; outline: none;
        }
        .unlock-btn {
            background: #e74c3c; color: white; border: none; padding: 10px 30px; font-size: 16px; border-radius: 50px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>
    
    <!-- ğŸ”’ ãƒ­ãƒƒã‚¯ç”»é¢ -->
    <div id="lockScreen">
        <div style="margin-bottom:20px; font-size:40px;">ğŸ”’</div>
        <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
        <input type="password" id="pinInput" maxlength="4" placeholder="****">
        <button class="unlock-btn" onclick="checkPin()">è§£é™¤</button>
        <p id="pinError" style="color:#e74c3c; height:20px; margin-top:10px;"></p>
    </div>

    <header>
        <h1>â˜ï¸ éµä»˜ããƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ v16</h1>
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        
        <div id="menuOverlay">
            <div class="storage-info">
                <div>â˜ï¸ ä½¿ç”¨é‡ (ç›®å®‰)</div>
                <div style="font-size:16px; font-weight:bold; margin:5px 0;" id="usageText">è¨ˆç®—ä¸­...</div>
                <div class="storage-bar-bg"><div class="storage-bar-fill" id="usageBar"></div></div>
                <div style="font-size:10px; opacity:0.7; margin-top:5px;">ä¸Šé™: 5GB (ç„¡æ–™æ )</div>
            </div>
            <!-- æ‰‹å‹•ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ -->
            <button class="menu-item" onclick="manualLock()" style="border:1px solid #e74c3c; background:rgba(231,76,60,0.1); color:#e74c3c; margin-top:10px;">ğŸ”’ ã™ãã«ãƒ­ãƒƒã‚¯ã™ã‚‹</button>
        </div>
    </header>

    <div id="loader">å‡¦ç†ä¸­...</div>

    <div id="libraryContainer">
        <p style="text-align:center; color:#ccc; margin-top:50px;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div class="fab-container">
        <button id="addFolderFab" class="fab-btn" onclick="createNewFolderDirect()"></button>
        <button id="startFab" class="fab-btn" onclick="openFolderSelector()"></button>
    </div>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç¾¤ -->
    <div id="folderOverlay" class="overlay-screen">
        <h3>ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</h3>
        <div id="folderGrid" class="folder-select-grid"></div>
        <button class="close-overlay-btn" onclick="closeAllOverlays()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <div id="recordingOverlay" class="overlay-screen">
        <div class="recording-status">ğŸ”´ éŒ²éŸ³ä¸­</div>
        <div class="timer-display" id="timer">00:00</div>
        <div id="currentFolderDisplay" style="margin-bottom:10px; opacity:0.7;"></div>
        <button class="big-stop-btn" onclick="pauseForReview()"><div></div></button>
    </div>

    <div id="reviewOverlay" class="overlay-screen">
        <div style="font-size:18px; margin-bottom:30px;">ä¸€æ™‚åœæ­¢ä¸­</div>
        <audio id="previewPlayer" controls style="width:100%; max-width:300px; margin-bottom:30px;"></audio>
        <div class="review-controls">
            <button class="action-btn btn-resume" onclick="resumeRecording()">â†©ï¸ å†é–‹</button>
            <button class="action-btn btn-save" onclick="confirmSave()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
            <button class="action-btn btn-discard" onclick="confirmDiscard()">ğŸ—‘ï¸ ç ´æ£„</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // â–¼â–¼â–¼ ã“ã“ã«Firebaseã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼
        const firebaseConfig = {apiKey: "AIzaSyANfuSVeic8GkhnRA107VkdZczHTgw2oEM",
  authDomain: "web-recorder-37128.firebaseapp.com",
  projectId: "web-recorder-37128",
  storageBucket: "web-recorder-37128.firebasestorage.app",
  messagingSenderId: "347477125584",
  appId: "1:347477125584:web:9d893502dbed76686e71d5"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ ---
        
        // 7æ—¥é–“ (ãƒŸãƒªç§’)
        const KEEP_UNLOCKED_DURATION = 7 * 24 * 60 * 60 * 1000; 

        // èµ·å‹•æ™‚ã«ãƒã‚§ãƒƒã‚¯
        const lastUnlockTime = localStorage.getItem('voiceAppLastUnlock');
        if (lastUnlockTime && (Date.now() - parseInt(lastUnlockTime) < KEEP_UNLOCKED_DURATION)) {
            // æœŸé™å†…ãªã‚‰ãƒ­ãƒƒã‚¯ç”»é¢ã‚’éš ã—ã¦èµ·å‹•
            document.getElementById('lockScreen').style.display = 'none';
            // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹ï¼ˆDOMèª­ã¿è¾¼ã¿å®‰å®šã®ãŸã‚ï¼‰
            setTimeout(() => initRealtimeListener(), 100);
        }

        window.checkPin = () => {
            const input = document.getElementById('pinInput');
            const error = document.getElementById('pinError');
            if(input.value === "1027") {
                // è§£é™¤æˆåŠŸï¼šæ™‚é–“ã‚’ä¿å­˜
                localStorage.setItem('voiceAppLastUnlock', Date.now());
                
                document.getElementById('lockScreen').style.display = 'none';
                initRealtimeListener();
            } else {
                error.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
                input.value = "";
            }
        };

        // æ‰‹å‹•ãƒ­ãƒƒã‚¯
        window.manualLock = () => {
            if(!confirm("ã‚¢ãƒ—ãƒªã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ")) return;
            localStorage.removeItem('voiceAppLastUnlock'); // è¨˜æ†¶ã‚’æ¶ˆã™
            location.reload(); // å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ­ãƒƒã‚¯ç”»é¢ã¸
        };


        // UIæ“ä½œ
        window.toggleMenu = () => document.getElementById('menuOverlay').classList.toggle('open');
        window.closeAllOverlays = () => document.querySelectorAll('.overlay-screen').forEach(el => el.classList.remove('active'));
        const loader = document.getElementById('loader');

        // çŠ¶æ…‹å¤‰æ•°
        let mediaRecorder = null, masterAudioChunks = [], targetFolder = "", timerInterval, startTime, elapsedTime = 0;

        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ ---
        function initRealtimeListener() {
            const container = document.getElementById('libraryContainer');
            // ã™ã§ã«ãƒªã‚¹ãƒŠãƒ¼ãŒå‹•ã„ã¦ã„ãŸã‚‰é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã‚¬ãƒ¼ãƒ‰ã¯ç°¡æ˜“ç‰ˆã§ã¯çœç•¥
            
            const qRecs = query(collection(db, "recordings"), orderBy("date", "desc"));
            const qFolders = query(collection(db, "folders"), orderBy("createdAt", "desc"));

            let foldersCache = [];
            let recordingsCache = [];

            const render = () => {
                container.innerHTML = '';
                
                let totalBytes = 0;
                recordingsCache.forEach(r => { if(r.filesize) totalBytes += r.filesize; });
                updateStorageDisplay(totalBytes);

                if(foldersCache.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">å³ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>';
                    return;
                }
                
                foldersCache.forEach(folder => {
                    const recs = recordingsCache.filter(r => r.folder === folder.name);
                    const div = document.createElement('div'); div.className = 'folder-section';
                    
                    let listHtml = recs.length ? recs.map(r => `
                        <li class="list-item">
                            <div class="item-info">
                                <span>${new Date(r.date).toLocaleString()}</span>
                                <button class="delete-btn" onclick="window.deleteRec('${r.id}', '${r.storagePath}')">å‰Šé™¤</button>
                            </div>
                            <audio controls src="${r.url}" preload="none"></audio>
                        </li>`).join('') : '<div style="padding:15px;color:#ccc;text-align:center;font-size:12px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    
                    div.innerHTML = `
                        <div class="folder-header"><span>ğŸ“‚ ${folder.name}</span><button class="delete-folder-btn" onclick="window.deleteFolder('${folder.name}')">Ã—</button></div>
                        <ul style="list-style:none;padding:0;margin:0;">${listHtml}</ul>
                    `;
                    container.appendChild(div);
                });
            };

            onSnapshot(qFolders, (snap) => {
                foldersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
            onSnapshot(qRecs, (snap) => {
                recordingsCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
        }

        function updateStorageDisplay(bytes) {
            const limit = 5 * 1024 * 1024 * 1024; 
            const percent = Math.min(100, (bytes / limit) * 100);
            const usedMB = (bytes / 1024 / 1024).toFixed(1);
            document.getElementById('usageText').textContent = `${usedMB} MB / 5 GB`;
            document.getElementById('usageBar').style.width = `${percent}%`;
        }

        window.createNewFolderDirect = async () => {
            const name = prompt("ãƒ•ã‚©ãƒ«ãƒ€å:");
            if(name && name.trim()) {
                loader.classList.add('active');
                try {
                    await setDoc(doc(db, "folders", name.trim()), {
                        name: name.trim(),
                        createdAt: new Date().toISOString()
                    });
                } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
                loader.classList.remove('active');
            }
        };

        window.openFolderSelector = () => {
            const grid = document.getElementById('folderGrid');
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</div>';
            document.getElementById('folderOverlay').classList.add('active');

            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(({ getDocs, query, collection, orderBy }) => {
                const q = query(collection(db, "folders"), orderBy("createdAt", "desc"));
                getDocs(q).then(snap => {
                    grid.innerHTML = '';
                    if(snap.empty) {
                        grid.innerHTML = '<div class="folder-btn" style="grid-column:1/-1" onclick="window.createNewFolderDirect()">ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</div>';
                    } else {
                        snap.forEach(d => {
                            const btn = document.createElement('div');
                            btn.className = 'folder-btn';
                            btn.textContent = d.data().name;
                            btn.onclick = () => startRecordingProcess(d.data().name);
                            grid.appendChild(btn);
                        });
                    }
                });
            });
        };

        async function startRecordingProcess(folderName) {
            targetFolder = folderName; masterAudioChunks = []; elapsedTime = 0;
            window.closeAllOverlays();
            document.getElementById('recordingOverlay').classList.add('active');
            document.getElementById('currentFolderDisplay').textContent = folderName;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.addEventListener('dataavailable', e => { if (e.data.size > 0) masterAudioChunks.push(e.data); });
                mediaRecorder.start();
                startTimer();
            } catch(e) { alert("ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™"); window.closeAllOverlays(); }
        }

        window.pauseForReview = () => {
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.requestData(); mediaRecorder.pause(); stopTimer();
                setTimeout(() => {
                    window.closeAllOverlays();
                    document.getElementById('reviewOverlay').classList.add('active');
                    const blob = new Blob(masterAudioChunks, { type: 'audio/webm' });
                    document.getElementById('previewPlayer').src = URL.createObjectURL(blob);
                }, 100);
            }
        };

        window.resumeRecording = () => {
            if(mediaRecorder && mediaRecorder.state === 'paused') {
                window.closeAllOverlays();
                document.getElementById('recordingOverlay').classList.add('active');
                mediaRecorder.resume(); startTimer();
            }
        };

        window.confirmSave = async () => {
            if(mediaRecorder) mediaRecorder.stop();
            window.closeAllOverlays();
            loader.classList.add('active');

            try {
                const blob = new Blob(masterAudioChunks, { type: 'audio/webm' });
                const fileSize = blob.size; 
                const fileName = `${Date.now()}.webm`;
                const storageRef = ref(storage, `audio/${fileName}`);

                await uploadBytes(storageRef, blob);
                const url = await getDownloadURL(storageRef);

                await addDoc(collection(db, "recordings"), {
                    folder: targetFolder,
                    url: url,
                    storagePath: `audio/${fileName}`,
                    filesize: fileSize, 
                    date: new Date().toISOString()
                });

                masterAudioChunks = [];
            } catch (e) {
                alert("ä¿å­˜å¤±æ•—: " + e.message);
            } finally {
                loader.classList.remove('active');
            }
        };

        window.confirmDiscard = () => {
            if(confirm("ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) {
                if(mediaRecorder) mediaRecorder.stop();
                window.closeAllOverlays();
                masterAudioChunks = [];
            }
        };

        window.deleteRec = async (id, storagePath) => {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            loader.classList.add('active');
            try {
                const fileRef = ref(storage, storagePath);
                await deleteObject(fileRef).catch(e => console.log("File gone"));
                await deleteDoc(doc(db, "recordings", id));
            } catch(e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
            loader.classList.remove('active');
        };

        window.deleteFolder = async (name) => {
            if(!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€ã¨ä¸­ã®éŒ²éŸ³ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            loader.classList.add('active');
            await deleteDoc(doc(db, "folders", name));
            loader.classList.remove('active');
        };

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime + elapsedTime;
                const m = Math.floor(diff / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); elapsedTime += Date.now() - startTime; }

    </script>
</body>
</html>
